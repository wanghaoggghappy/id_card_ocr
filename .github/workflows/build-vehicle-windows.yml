name: Build Vehicle Archive Processor (Windows)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'vehicle-v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-vehicle-windows:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        echo "Installing from requirements-build.txt..."
        pip install -r requirements-build.txt
        echo "Installation complete!"
      continue-on-error: false
        
    - name: â„¹ï¸ Verify installation
      env:
        PYTHONIOENCODING: utf-8
      run: |
        chcp 65001
        echo "=========================================="
        echo "Python Environment Information"
        echo "=========================================="
        python --version
        echo ""
        echo "Pip version:"
        pip --version
        echo ""
        echo "=========================================="
        echo "Verifying Critical Packages"
        echo "=========================================="
        python -c "import cv2; print('[OK] OpenCV:', cv2.__version__)"
        python -c "import fitz; print('[OK] PyMuPDF:', fitz.__version__)"
        python -c "import paddleocr; print('[OK] PaddleOCR installed')"
        python -c "import openpyxl; print('[OK] openpyxl:', openpyxl.__version__)"
        python -c "import PyInstaller; print('[OK] PyInstaller:', PyInstaller.__version__)"
        echo "=========================================="
        echo "All packages verified successfully!"
        
    - name: ðŸ”¨ Build Windows EXE
      env:
        PYTHONIOENCODING: utf-8
      run: |
        chcp 65001
        python build_vehicle_exe.py
        
    - name: âœ… Verify build output
      run: |
        dir dist\VehicleArchiveProcessor
        if not exist "dist\VehicleArchiveProcessor\VehicleArchiveProcessor.exe" (
          echo Error: EXE not found!
          exit 1
        )
        echo Build successful!
        
    - name: ðŸ§ª Test EXE (help command)
      env:
        PYTHONIOENCODING: utf-8
      run: |
        chcp 65001
        cd dist\VehicleArchiveProcessor
        .\VehicleArchiveProcessor.exe --help
        .\VehicleArchiveProcessor.exe --version
        
    - name: ðŸ“ Create build info
      run: |
        echo Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss") > dist\VehicleArchiveProcessor\BUILD_INFO.txt
        echo Git Commit: ${{ github.sha }} >> dist\VehicleArchiveProcessor\BUILD_INFO.txt
        echo Git Branch: ${{ github.ref_name }} >> dist\VehicleArchiveProcessor\BUILD_INFO.txt
        echo Build Number: ${{ github.run_number }} >> dist\VehicleArchiveProcessor\BUILD_INFO.txt
        if ("${{ github.event.inputs.version }}" -ne "") {
          echo Version: ${{ github.event.inputs.version }} >> dist\VehicleArchiveProcessor\BUILD_INFO.txt
        }
        
    - name: ðŸ“¦ Create ZIP archive
      run: |
        cd dist
        Compress-Archive -Path VehicleArchiveProcessor -DestinationPath VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip -CompressionLevel Optimal
        
    - name: ðŸ“Š Calculate package size
      run: |
        $size = (Get-Item dist\VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip).Length / 1MB
        Write-Host "Package size: $([math]::Round($size, 2)) MB"
        
    - name: ðŸ“¤ Upload artifact (development builds)
      if: "!startsWith(github.ref, 'refs/tags/')"
      uses: actions/upload-artifact@v4
      with:
        name: VehicleArchiveProcessor-Windows-build${{ github.run_number }}
        path: dist/VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip
        retention-days: 30
        compression-level: 0
        
    - name: ðŸ“¤ Upload folder artifact (for testing)
      if: "!startsWith(github.ref, 'refs/tags/')"
      uses: actions/upload-artifact@v4
      with:
        name: VehicleArchiveProcessor-Folder-build${{ github.run_number }}
        path: dist/VehicleArchiveProcessor/
        retention-days: 7
        
    - name: ðŸš€ Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/vehicle-v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## è½¦è¾†æ¡£æ¡ˆæ‰¹å¤„ç†ç³»ç»Ÿ - Windowsç‰ˆæœ¬
          
          ### ðŸ“¥ ä¸‹è½½å®‰è£…
          1. ä¸‹è½½ä¸‹æ–¹çš„ `VehicleArchiveProcessor-Windows-*.zip` æ–‡ä»¶
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡»è¿è¡Œ `å¯åŠ¨-æ‹–æ”¾æ–‡ä»¶.bat`
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - âœ… è‡ªåŠ¨æå–è½¦æž¶å·ï¼ˆVINï¼‰- æ”¯æŒè¡Œé©¶è¯ã€ç™»è®°è¯ã€å‘ç¥¨
          - âœ… è‡ªåŠ¨æå–è½¦ä¸»å§“å
          - âœ… è‡ªåŠ¨æå–æ–°è½¦ä¸»å§“åï¼ˆç™»è®°è¯ï¼‰
          - âœ… è‡ªåŠ¨æå–äº¤æ˜“é‡‘é¢ï¼ˆå‘ç¥¨ï¼‰
          - âœ… VINä¸åŒ¹é…è‡ªåŠ¨æ ‡çº¢æç¤º
          - âœ… ç”ŸæˆExcelæ±‡æ€»è¡¨
          - âœ… æŒ‰è½¦æž¶å·æ•´ç†æ–‡ä»¶
          
          ### ðŸ“ ä½¿ç”¨è¯´æ˜Ž
          è¯¦è§åŽ‹ç¼©åŒ…å†…çš„ `ä½¿ç”¨è¯´æ˜Ž.txt` æ–‡ä»¶
          
          ### ðŸ’» ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - ä¸éœ€è¦å®‰è£…Python
          - é¦–æ¬¡è¿è¡Œéœ€è¦è”ç½‘ä¸‹è½½OCRæ¨¡åž‹
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          è¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤
          
          ---
          
          **æž„å»ºä¿¡æ¯**
          - æž„å»ºæ—¶é—´: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - æž„å»ºç¼–å·: #${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“Š Build summary
      if: always()
      run: |
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $env:GITHUB_STEP_SUMMARY
        echo "- **EXEæ–‡ä»¶**: VehicleArchiveProcessor.exe" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ZIPåŒ…**: VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Pythonç‰ˆæœ¬**: 3.11" >> $env:GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç¼–å·**: #${{ github.run_number }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
        if (Test-Path "dist\VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip") {
          $size = (Get-Item "dist\VehicleArchiveProcessor-Windows-${{ github.run_number }}.zip").Length / 1MB
          echo "- **åŒ…å¤§å°**: $([math]::Round($size, 2)) MB" >> $env:GITHUB_STEP_SUMMARY
        }
